<!DOCTYPE html>  <html> <head>   <title>monitor.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="../docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="..//forever/cli.html">                 forever/cli.html               </a>                                           <a class="source" href="..//forever/monitor.html">                 forever/monitor.html               </a>                                           <a class="source" href="..//forever.html">                 forever.html               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               monitor.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * monitor.js: Core functionality for the Monitor object.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 2010 Charlie Robbins</span>
<span class="cm"> * MIT LICENCE</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">),</span>
    <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
    <span class="nx">events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">),</span>
    <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span><span class="p">,</span>
    <span class="nx">winston</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;winston&#39;</span><span class="p">),</span>
    <span class="nx">forever</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../forever&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>function Monitor (script, options)</h3>

<h4>@script {string} Location of the target script to run.</h4>

<h4>@options {Object} Configuration for this instance.</h4>

<p>Creates a new instance of forever with specified params.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Monitor</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">Monitor</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Setup basic configuration options</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">options</span>          <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">silent</span>      <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">forever</span>     <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">forever</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">uid</span>         <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">uid</span> <span class="o">||</span> <span class="nx">forever</span><span class="p">.</span><span class="nx">randomString</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pidFile</span>     <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">pidFile</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">forever</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pidPath&#39;</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">uid</span> <span class="o">+</span> <span class="s1">&#39;.pid&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">max</span>         <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">max</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">childExists</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">times</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Setup restart timing. These options control how quickly forever restarts
a child process as well as when to kill a "spinning" process</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">minUptime</span>     <span class="o">=</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">minUptime</span> <span class="o">!==</span> <span class="s1">&#39;number&#39;</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">minUptime</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">spinSleepTime</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">spinSleepTime</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Setup the command to spawn and the options to pass
to that command.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">command</span>   <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">command</span> <span class="o">||</span> <span class="s1">&#39;node&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">options</span>   <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">options</span> <span class="o">||</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">spawnWith</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">spawnWith</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">sourceDir</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sourceDir</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cwd</span>       <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">cwd</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">env</span>       <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">env</span> <span class="o">||</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Setup log files and logger for this instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">logFile</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logFile</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">forever</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">uid</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">outFile</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">outFile</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">errFile</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">errFile</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">logger</span>  <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logger</span> <span class="o">||</span> <span class="k">new</span> <span class="p">(</span><span class="nx">winston</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)({</span>
    <span class="nx">transports</span><span class="o">:</span> <span class="p">[</span><span class="k">new</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">Console</span><span class="p">({</span> <span class="nx">silent</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">silent</span> <span class="p">})]</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Extend from the winston logger.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">script</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">command</span> <span class="o">=</span> <span class="nx">script</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sourceDir</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sourceDir</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>If we should log stdout, open a file buffer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outFile</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stdout</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outFile</span><span class="p">,</span> <span class="p">{</span> <span class="nx">flags</span><span class="o">:</span> <span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="nx">encoding</span><span class="o">:</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">mode</span><span class="o">:</span> <span class="mi">0666</span> <span class="p">});</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If we should log stderr, open a file buffer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">errFile</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stderr</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">errFile</span><span class="p">,</span> <span class="p">{</span> <span class="nx">flags</span><span class="o">:</span> <span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="nx">encoding</span><span class="o">:</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">mode</span><span class="o">:</span> <span class="mi">0666</span> <span class="p">});</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Last if any hooks have been passed in attach
this instance to them</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">hooks</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">hooks</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">hooks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">hook</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">hook</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">hook</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">hook</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Inherit from events.EventEmitter</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">sys</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Monitor</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>function start ([restart])</h3>

<h4>@restart {boolean} Value indicating whether this is a restart.</h4>

<p>Start the process that this instance is configured for</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Monitor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">restart</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">restart</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot start process that is already running.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">trySpawn</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Target script does not exist: &#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">ctime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">running</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">restart</span> <span class="o">?</span> <span class="s1">&#39;restart&#39;</span> <span class="o">:</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Hook all stream data and process it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">listenTo</span> <span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">ldata</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">silent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">[</span><span class="nx">stream</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If we haven't been silenced, and we don't have a file stream
to output to write to the process stdout stream</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">[</span><span class="nx">stream</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If we have been given an output file for the stream, write to it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">self</span><span class="p">[</span><span class="nx">stream</span><span class="p">].</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">child</span><span class="p">[</span><span class="nx">stream</span><span class="p">].</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">ldata</span><span class="p">);</span>

    <span class="nx">child</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">child</span><span class="p">[</span><span class="nx">stream</span><span class="p">].</span><span class="nx">removeListener</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">ldata</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Listen to stdout and stderr</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">listenTo</span><span class="p">(</span><span class="s1">&#39;stdout&#39;</span><span class="p">);</span>
  <span class="nx">listenTo</span><span class="p">(</span><span class="s1">&#39;stderr&#39;</span><span class="p">);</span>

  <span class="nx">child</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">spinning</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ctime</span> <span class="o">&lt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">minUptime</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Forever detected script exited with code: &#39;</span> <span class="o">+</span> <span class="nx">code</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">letChildDie</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">running</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>If had to write to an stdout file, close it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>If had to write to an stderr file, close it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">spinning</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">restartChild</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Forever restarting script for &#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">times</span> <span class="o">+</span> <span class="s1">&#39; time&#39;</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">times</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">forceStop</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">forever</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">times</span> <span class="o">&gt;=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span>
      <span class="o">||</span> <span class="p">(</span><span class="nx">spinning</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">self</span><span class="p">.</span><span class="nx">spinSleepTime</span> <span class="o">!==</span> <span class="s1">&#39;number&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">letChildDie</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">spinning</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">restartChild</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">spinSleepTime</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">restartChild</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h3>function trySpawn()</h3>

<p>Tries to spawn the target Forever child process. Depending on
configuration, it checks the first argument of the options
to see if the file exists. This is useful is you are
trying to execute a script with an env: e.g. node myfile.js</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Monitor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trySpawn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">command</span> <span class="o">===</span> <span class="s1">&#39;node&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checkFile</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">childExists</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">stats</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">childExists</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">spawnWith</span><span class="p">.</span><span class="nx">cwd</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cwd</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">spawnWith</span><span class="p">.</span><span class="nx">cwd</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">spawnWith</span><span class="p">.</span><span class="nx">env</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getEnv</span><span class="p">();</span>

  <span class="k">return</span> <span class="nx">spawn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">command</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">spawnWith</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h3>@data {Object}</h3>

<p>Responds with the appropriate information about
this <code>Monitor</code> instance and it's associated child process.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Monitor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__defineGetter__</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>TODO: Return settings from this forever instance
with a state indicator that it is currently stopped.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="p">{};</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">childData</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">ctime</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctime</span><span class="p">,</span>
    <span class="nx">command</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">command</span><span class="p">,</span>
    <span class="nx">file</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">foreverPid</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="p">,</span>
    <span class="nx">logFile</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">logFile</span><span class="p">,</span>
    <span class="nx">options</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="nx">pid</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">child</span><span class="p">.</span><span class="nx">pid</span><span class="p">,</span>
    <span class="nx">silent</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">silent</span><span class="p">,</span>
    <span class="nx">uid</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uid</span>
  <span class="p">};</span>

  <span class="p">[</span><span class="s1">&#39;pidFile&#39;</span><span class="p">,</span> <span class="s1">&#39;outFile&#39;</span><span class="p">,</span> <span class="s1">&#39;errFile&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="s1">&#39;cwd&#39;</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">childData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sourceDir</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">childData</span><span class="p">.</span><span class="nx">sourceDir</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sourceDir</span><span class="p">;</span>
    <span class="nx">childData</span><span class="p">.</span><span class="nx">file</span> <span class="o">=</span> <span class="nx">childData</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sourceDir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">childData</span> <span class="o">=</span> <span class="nx">childData</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">childData</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Setup the forever process to listen to
SIGINT and SIGTERM events so that we can
clean up the *.pid file</p>

<p>Remark: This should work, but the fd gets screwed up
        with the daemon process.</p>

<p>process.on('SIGINT', function () {
  process.exit(0);
});</p>

<p>process.on('SIGTERM', function () {
  process.exit(0);
});
process.on('exit', function () {
  fs.unlinkSync(childPath);
});</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h3>function restart ()</h3>

<p>Restarts the target script associated with this instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Monitor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">restart</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">kill</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>function stop ()</h3>

<p>Stops the target script associated with this instance. Prevents it from auto-respawning</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Monitor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">kill</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h3>function kill (forceStop)</h3>

<h4>@forceStop {boolean} Value indicating whether short circuit forever auto-restart.</h4>

<p>Kills the ChildProcess object associated with this instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Monitor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">kill</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">forceStop</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">child</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">running</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot stop process that is not running.&#39;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Set an instance variable here to indicate this
stoppage is forced so that when <code>child.on('exit', ..)</code>
fires in <code>Monitor.prototype.start</code> we can short circuit
and prevent auto-restart</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">forceStop</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">forceStop</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">child</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">childData</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h3>@private function _getEnv ()</h3>

<p>Returns the environment variables that should be passed along
to the target process spawned by this instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Monitor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_getEnv</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span>   <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">extra</span>  <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">env</span><span class="p">),</span>
      <span class="nx">merged</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">extra</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">addKey</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">merged</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Mixin the key:value pairs from <code>process.env</code> and the custom
environment variables in <code>this.env</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span> <span class="nx">addKey</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">)</span> <span class="p">});</span>
  <span class="nx">extra</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span> <span class="nx">addKey</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">env</span><span class="p">)</span> <span class="p">});</span>

  <span class="k">return</span> <span class="nx">merged</span><span class="p">;</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 